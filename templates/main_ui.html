<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expert Mode | AWS OMAKASE</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/vs.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/json.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/yaml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/hcl.min.js"></script>

    <style>
        body {
            font-family: 'Pretendard', sans-serif;
            background-color: #f2f3f3;
            color: #16191f;
            overflow: hidden;
        }

        /* AWS Utilities */
        .aws-btn {
            background-color: #ec7211;
            color: #ffffff;
            font-weight: 700;
            transition: all 0.2s;
            border: 1px solid #ec7211;
        }

        .aws-btn:hover {
            background-color: #eb5f07;
            border-color: #dd5906;
        }

        /* 3-Column Layout: Global Nav | Controls | Main Canvas */
        .grid-layout {
            display: grid;
            grid-template-columns: 64px 450px 1fr;
            height: calc(100vh - 56px);
        }

        /* Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f2f3f3;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #d5dbdb;
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }

        /* Left Control Panel Styles */
        .option-group {
            margin-bottom: 24px;
            padding-bottom: 24px;
            border-bottom: 1px solid #d5dbdb;
        }

        .group-title {
            font-size: 11px;
            font-weight: 800;
            color: #545b64;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .option-card {
            background: #ffffff;
            border: 1px solid #d5dbdb;
            padding: 16px;
            border-radius: 4px;
            /* AWS styling */
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .option-card:hover {
            border-color: #ec7211;
        }

        .option-card.active {
            background: #fff7ee;
            border: 2px solid #ec7211;
            box-shadow: 0 4px 6px -1px rgba(236, 114, 17, 0.1);
        }

        .check-icon {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 18px;
            height: 18px;
            background: #ec7211;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transform: scale(0);
            transition: all 0.2s;
            color: white;
        }

        .option-card.active .check-icon {
            opacity: 1;
            transform: scale(1);
        }

        .input-light {
            width: 100%;
            background: #ffffff;
            border: 1px solid #d5dbdb;
            color: #16191f;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 13px;
            outline: none;
            transition: 0.2s;
        }

        .input-light:focus {
            border-color: #ec7211;
            box-shadow: 0 0 0 1px #ec7211;
        }

        .input-error {
            border-color: #d13212 !important;
        }

        .err-msg {
            color: #d13212;
            font-size: 11px;
            margin-top: 4px;
            display: none;
            font-weight: 700;
        }

        .slider-container {
            margin-top: 14px;
        }

        .slider-val {
            float: right;
            font-weight: bold;
            color: #ec7211;
        }

        input[type=range] {
            width: 100%;
            accent-color: #ec7211;
            height: 4px;
            background: #d5dbdb;
            border-radius: 2px;
            cursor: pointer;
        }

        /* Tabs */
        .tab-header {
            display: flex;
            background: #ffffff;
            border-bottom: 1px solid #d5dbdb;
            flex-shrink: 0;
        }

        .tab-btn {
            padding: 14px 20px;
            font-size: 12px;
            font-weight: 700;
            color: #545b64;
            cursor: pointer;
            border-right: 1px solid #f2f3f3;
            border-bottom: 3px solid transparent;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            background: #fff;
        }

        .tab-btn:hover {
            color: #ec7211;
            background: #fafafa;
        }

        .tab-btn.active {
            color: #ec7211;
            border-bottom-color: #ec7211;
            background: #ffffff;
        }

        /* Topology */
        .topo-container {
            background: #ffffff;
            border: 1px solid #d5dbdb;
            padding: 24px;
            border-radius: 8px;
            position: relative;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .topo-region {
            border: 2px dashed #9ca3af;
            padding: 20px;
            border-radius: 8px;
            position: relative;
            margin-top: 10px;
        }

        .topo-label {
            position: absolute;
            top: -12px;
            left: 16px;
            background: #ffffff;
            padding: 0 8px;
            font-size: 11px;
            color: #545b64;
            font-weight: 800;
        }

        .topo-vpc {
            border: 2px solid #16a34a;
            padding: 20px;
            border-radius: 8px;
            background: #f0fdf4;
            position: relative;
            margin-top: 20px;
        }

        .topo-vpc-label {
            position: absolute;
            top: -10px;
            left: 16px;
            font-size: 11px;
            color: #16a34a;
            background: #ffffff;
            padding: 0 6px;
            font-weight: bold;
            border: 1px solid #16a34a;
            border-radius: 4px;
        }

        .topo-az-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .topo-az {
            border: 1px dashed #3b82f6;
            padding: 15px;
            border-radius: 8px;
            background: #eff6ff;
            position: relative;
        }

        .topo-az-label {
            position: absolute;
            top: -10px;
            right: 10px;
            font-size: 10px;
            color: #3b82f6;
            background: #ffffff;
            padding: 0 6px;
            font-weight: bold;
            border: 1px solid #3b82f6;
            border-radius: 4px;
        }

        .topo-subnet {
            background: #ffffff;
            border: 1px solid #d5dbdb;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 11px;
            color: #16191f;
            font-weight: 600;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .topo-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        /* Content Area & Scroll */
        .content-area-fixed {
            position: relative;
            flex: 1;
            background: #f2f3f3;
            overflow: hidden;
        }

        .scroll-view-absolute {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow-y: auto;
            padding: 24px;
        }

        pre {
            margin: 0;
            padding: 0;
            font-family: 'Menlo', 'Monaco', monospace !important;
            font-size: 12px !important;
            line-height: 1.6 !important;
            background: transparent !important;
            white-space: pre;
        }

        code {
            background: transparent !important;
        }
    </style>
</head>

<body class="flex flex-col h-screen">

    <!-- Style A Header -->
    <header
        class="bg-[#232f3e] text-white px-5 py-3 flex justify-between items-center shadow-md z-50 shrink-0 h-[56px]">
        <div class="flex items-center gap-3">
            <button onclick="location.href='/'" class="hover:text-[#ec7211] transition" title="Go Home">
                <i data-lucide="box" class="w-6 h-6 text-[#ec7211]"></i>
            </button>
            <h1 class="text-base font-bold tracking-tight">Management Console <span class="text-[#ec7211] font-normal">|
                    Expert Mode</span></h1>
        </div>
        <div class="flex items-center gap-8 text-sm">
            <div class="flex flex-col items-end">
                <span class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Target Region</span>
                <select id="region_select" onchange="refreshEngine()"
                    class="bg-transparent text-white font-bold outline-none cursor-pointer hover:text-[#ec7211] transition text-xs">
                    <option value="ap-northeast-2" class="text-black">ap-northeast-2 (Seoul)</option>
                    <option value="us-east-1" class="text-black">us-east-1 (N. Virginia)</option>
                    <option value="us-west-2" class="text-black">us-west-2 (Oregon)</option>
                    <option value="ap-northeast-1" class="text-black">ap-northeast-1 (Tokyo)</option>
                    <option value="eu-central-1" class="text-black">eu-central-1 (Frankfurt)</option>
                </select>
            </div>
            <div class="h-8 w-px bg-gray-600"></div>
            <div class="flex flex-col items-end">
                <span class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Est. Cost</span>
                <span class="font-bold text-green-400 text-base font-mono" id="header-cost">$ 0.00</span>
            </div>
            <button onclick="deploy()"
                class="aws-btn px-6 py-1.5 rounded shadow-lg flex items-center gap-2 transition hover:scale-105 font-bold text-sm">
                <i data-lucide="rocket" class="w-4 h-4"></i> Provision Stack
            </button>
        </div>
    </header>

    <div class="grid-layout">
        <!-- 1. Global Sidebar (Style A) -->
        <nav class="bg-[#232f3e] flex flex-col items-center py-4 gap-6 border-t border-gray-700">
            <i onclick="location.href='/'" data-lucide="home"
                class="w-5 h-5 text-gray-400 hover:text-[#ec7211] cursor-pointer hover:scale-110 transition"
                title="Home"></i>
            <i onclick="location.href='/monitoring'" data-lucide="activity"
                class="w-5 h-5 text-gray-400 hover:text-[#ec7211] cursor-pointer hover:scale-110 transition"
                title="Monitoring"></i>
            <i onclick="location.href='/history'" data-lucide="list"
                class="w-5 h-5 text-gray-400 hover:text-[#ec7211] cursor-pointer hover:scale-110 transition"
                title="History"></i>
            <i data-lucide="settings"
                class="w-5 h-5 text-gray-400 hover:text-[#ec7211] cursor-pointer hover:scale-110 transition mt-auto mb-4"
                title="Settings"></i>
        </nav>

        <!-- 2. Control Panel (Local Nav) -->
        <div class="bg-white border-r border-[#d5dbdb] overflow-y-auto p-6 custom-scrollbar">
            <div class="option-group">
                <div class="group-title"><i data-lucide="tag" class="w-4 h-4 text-[#ec7211]"></i> 1. Resource Identity
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="text-[11px] font-bold text-[#545b64] mb-1 block">SERVICE IDENTIFIER</label>
                        <input type="text" id="svc_name" onkeyup="validateAndRefresh()"
                            placeholder="e.g. core-payment-api" class="input-light">
                        <p id="err_name" class="err-msg">Lowercase alphanumeric only.</p>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-[11px] font-bold text-[#545b64] mb-1 block">ENVIRONMENT</label>
                            <select id="env_tag" onchange="refreshEngine()" class="input-light cursor-pointer">
                                <option value="dev">Development</option>
                                <option value="stg">Staging</option>
                                <option value="prod">Production</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-[11px] font-bold text-[#545b64] mb-1 block">OWNER</label>
                            <input type="text" value="DevOps-Team" class="input-light bg-gray-50 text-gray-500"
                                readonly>
                        </div>
                    </div>
                </div>
            </div>

            <div class="option-group">
                <div class="group-title"><i data-lucide="cpu" class="w-4 h-4 text-[#ec7211]"></i> 2. Compute Engine
                </div>
                <div class="space-y-3">
                    <div class="option-card active" onclick="setInstanceTier('t3.micro', 25, this)">
                        <div class="bg-gray-100 p-2 rounded"><i data-lucide="coffee" class="w-5 h-5 text-gray-500"></i>
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between"><span class="text-sm font-bold text-[#16191f]">Starter
                                    (t3.micro)</span> <span
                                    class="text-xs font-bold text-green-600 bg-green-50 px-2 py-0.5 rounded">$25</span>
                            </div>
                            <div class="text-[11px] text-[#545b64]">2vCPU, 1GB RAM</div>
                        </div>
                        <div class="check-icon"><i data-lucide="check" class="w-3 h-3 text-white"></i></div>
                    </div>
                    <div class="option-card" onclick="setInstanceTier('m5.large', 90, this)">
                        <div class="bg-blue-50 p-2 rounded"><i data-lucide="server" class="w-5 h-5 text-blue-500"></i>
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between"><span class="text-sm font-bold text-[#16191f]">Standard
                                    (m5.large)</span> <span
                                    class="text-xs font-bold text-green-600 bg-green-50 px-2 py-0.5 rounded">$90</span>
                            </div>
                            <div class="text-[11px] text-[#545b64]">2vCPU, 8GB RAM</div>
                        </div>
                        <div class="check-icon"><i data-lucide="check" class="w-3 h-3 text-white"></i></div>
                    </div>
                    <div class="option-card" onclick="setInstanceTier('c5.xlarge', 170, this)">
                        <div class="bg-orange-50 p-2 rounded"><i data-lucide="zap" class="w-5 h-5 text-[#ec7211]"></i>
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between"><span class="text-sm font-bold text-[#16191f]">Performance
                                    (c5.xlarge)</span> <span
                                    class="text-xs font-bold text-green-600 bg-green-50 px-2 py-0.5 rounded">$170</span>
                            </div>
                            <div class="text-[11px] text-[#545b64]">4vCPU, 8GB RAM</div>
                        </div>
                        <div class="check-icon"><i data-lucide="check" class="w-3 h-3 text-white"></i></div>
                    </div>
                </div>
                <div class="slider-container mt-6">
                    <label class="text-[11px] font-bold text-[#545b64] mb-2 flex justify-between">
                        <span>DESIRED CAPACITY</span>
                        <span id="node_val" class="text-[#ec7211]">2 Nodes</span>
                    </label>
                    <input type="range" id="node_count" min="1" max="20" value="2"
                        oninput="updateSlider('node_val', this.value, ' Nodes'); refreshEngine()">
                </div>
            </div>

            <div class="option-group">
                <div class="group-title"><i data-lucide="database" class="w-4 h-4 text-[#ec7211]"></i> 3. Persistence
                    Layer</div>
                <select id="db_engine" onchange="refreshEngine()" class="input-light mb-4 cursor-pointer">
                    <option value="mysql">Amazon RDS for MySQL 8.0</option>
                    <option value="postgres">Amazon RDS for PostgreSQL 15</option>
                    <option value="aurora">Amazon Aurora (Serverless v2)</option>
                </select>
                <div class="flex items-center gap-3 mb-3 p-3 bg-white rounded border border-[#d5dbdb]">
                    <input type="checkbox" id="chk_multiaz" checked onchange="refreshEngine()"
                        class="w-4 h-4 accent-[#ec7211] cursor-pointer">
                    <span class="text-xs font-bold text-gray-700">Multi-AZ Deployment (HA)</span>
                </div>
                <div class="flex items-center gap-3 mb-4 p-3 bg-white rounded border border-[#d5dbdb]">
                    <input type="checkbox" id="chk_redis" onchange="refreshEngine()"
                        class="w-4 h-4 accent-[#ec7211] cursor-pointer">
                    <span class="text-xs font-bold text-gray-700">Add ElastiCache Redis</span>
                </div>
                <div class="slider-container">
                    <label class="text-[11px] font-bold text-[#545b64] mb-2 flex justify-between">
                        <span>STORAGE SIZE</span>
                        <span id="db_size_val" class="text-[#ec7211]">50 GB</span>
                    </label>
                    <input type="range" id="db_size" min="20" max="1000" step="10" value="50"
                        oninput="updateSlider('db_size_val', this.value, ' GB'); refreshEngine()">
                </div>
            </div>

            <div class="option-group border-none">
                <div class="group-title"><i data-lucide="shield" class="w-4 h-4 text-[#ec7211]"></i> 4. Network &
                    Security</div>
                <div class="space-y-3">
                    <div
                        class="flex items-center justify-between p-3 rounded bg-white border border-[#d5dbdb] hover:border-[#ec7211] transition">
                        <span class="text-xs font-bold text-gray-700 flex items-center gap-2"><i
                                data-lucide="shield-check" class="w-4 h-4 text-green-500"></i> Enable AWS WAF</span>
                        <input type="checkbox" id="chk_waf" onchange="refreshEngine()"
                            class="w-4 h-4 accent-[#ec7211] cursor-pointer">
                    </div>
                    <div
                        class="flex items-center justify-between p-3 rounded bg-white border border-[#d5dbdb] hover:border-[#ec7211] transition">
                        <span class="text-xs font-bold text-gray-700 flex items-center gap-2"><i data-lucide="globe"
                                class="w-4 h-4 text-blue-500"></i> CloudFront CDN</span>
                        <input type="checkbox" id="chk_cdn" onchange="refreshEngine()"
                            class="w-4 h-4 accent-[#ec7211] cursor-pointer">
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. Main Content (Canvas) -->
        <div class="bg-[#f0f2f3] flex flex-col min-w-0 h-full relative">

            <div class="tab-header shrink-0 z-10 relative">
                <div class="tab-btn active" onclick="switchTab('topology')"><i data-lucide="map" class="w-4 h-4"></i>
                    Topology Map</div>
                <div class="tab-btn" onclick="switchTab('terraform')"><i data-lucide="code-2" class="w-4 h-4"></i>
                    Terraform (IaC)</div>
                <div class="tab-btn" onclick="switchTab('cfn')"><i data-lucide="file-json" class="w-4 h-4"></i>
                    CloudFormation</div>
                <div class="tab-btn" onclick="switchTab('cost')"><i data-lucide="dollar-sign" class="w-4 h-4"></i> Cost
                    Analysis</div>
            </div>

            <div class="content-area-fixed">

                <div id="tab-topology" class="scroll-view-absolute">
                    <div class="topo-container">
                        <h3 class="text-xs font-bold text-[#545b64] uppercase mb-6 flex justify-between items-center">
                            <span>Target Architecture Diagram</span>
                            <span class="text-[#ec7211] flex items-center gap-1 bg-orange-50 px-2 py-1 rounded-full"><i
                                    data-lucide="refresh-cw" class="w-3 h-3"></i> Live Sync</span>
                        </h3>
                        <div class="flex justify-center mb-6">
                            <div class="flex flex-col items-center gap-2">
                                <div
                                    class="w-12 h-12 bg-white border-2 border-[#ec7211] rounded-full flex items-center justify-center shadow-sm">
                                    <i data-lucide="globe" class="w-6 h-6 text-[#ec7211]"></i>
                                </div>
                                <span class="text-[10px] font-bold text-[#545b64] uppercase tracking-wide">Internet
                                    Gateway</span>
                            </div>
                        </div>
                        <div class="topo-region">
                            <div class="topo-label" id="region-label">AWS Region: ap-northeast-2</div>
                            <div class="topo-vpc">
                                <div class="topo-vpc-label">VPC (10.0.0.0/16)</div>
                                <div class="flex justify-center mb-6" id="topo-lb-layer"></div>
                                <div class="topo-az-grid" id="topo-az-container"></div>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-4 gap-4 mt-6">
                        <div class="p-4 bg-white border border-[#d5dbdb] rounded-lg flex flex-col gap-1 shadow-sm"><span
                                class="text-[10px] font-bold text-gray-400 uppercase">Encryption</span><span
                                class="text-sm font-bold text-green-600 flex items-center gap-1"><i
                                    data-lucide="check-circle" class="w-4 h-4"></i> KMS Enforced</span></div>
                        <div class="p-4 bg-white border border-[#d5dbdb] rounded-lg flex flex-col gap-1 shadow-sm"><span
                                class="text-[10px] font-bold text-gray-400 uppercase">Public Access</span><span
                                class="text-sm font-bold text-green-600 flex items-center gap-1"><i data-lucide="lock"
                                    class="w-4 h-4"></i> Blocked</span></div>
                        <div class="p-4 bg-white border border-[#d5dbdb] rounded-lg flex flex-col gap-1 shadow-sm"><span
                                class="text-[10px] font-bold text-gray-400 uppercase">Availability</span><span
                                class="text-sm font-bold" id="stat-ha">Checking...</span></div>
                        <div class="p-4 bg-white border border-[#d5dbdb] rounded-lg flex flex-col gap-1 shadow-sm"><span
                                class="text-[10px] font-bold text-gray-400 uppercase">Backup Policy</span><span
                                class="text-sm font-bold text-blue-600">Daily Snapshots</span></div>
                    </div>
                </div>

                <div id="tab-terraform" class="scroll-view-absolute hidden bg-white">
                    <div
                        class="flex justify-between items-center mb-3 sticky top-0 bg-white z-10 pb-2 border-b border-gray-100">
                        <h3 class="text-sm font-bold text-[#ec7211] flex items-center gap-2"><i data-lucide="file-code"
                                class="w-4 h-4"></i> main.tf</h3>
                        <button
                            class="text-[10px] bg-white border border-gray-300 px-3 py-1 rounded font-bold text-gray-700 hover:bg-gray-50 shadow-sm"
                            onclick="copyToClipboard('code-tf')">Copy Code</button>
                    </div>
                    <pre><code class="language-hcl" id="code-tf"># Generating...</code></pre>
                </div>

                <div id="tab-cfn" class="scroll-view-absolute hidden bg-white">
                    <div
                        class="flex justify-between items-center mb-3 sticky top-0 bg-white z-10 pb-2 border-b border-gray-100">
                        <h3 class="text-sm font-bold text-[#ec7211] flex items-center gap-2"><i data-lucide="file-json"
                                class="w-4 h-4"></i> stack.json</h3>
                        <button
                            class="text-[10px] bg-white border border-gray-300 px-3 py-1 rounded font-bold text-gray-700 hover:bg-gray-50 shadow-sm"
                            onclick="copyToClipboard('code-cfn')">Copy Code</button>
                    </div>
                    <pre><code class="language-json" id="code-cfn"></code></pre>
                </div>

                <div id="tab-cost" class="scroll-view-absolute hidden">
                    <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                        <h3 class="text-sm font-bold text-gray-500 uppercase mb-6">Detailed Bill Estimation</h3>
                        <table class="w-full text-xs text-gray-700">
                            <thead class="border-b-2 border-gray-100 text-left text-gray-400 uppercase tracking-wider">
                                <tr>
                                    <th class="pb-3 pl-2">Resource</th>
                                    <th class="pb-3">Spec</th>
                                    <th class="pb-3 text-right">Unit Price</th>
                                    <th class="pb-3 text-right">Quantity</th>
                                    <th class="pb-3 text-right pr-2">Total</th>
                                </tr>
                            </thead>
                            <tbody id="cost-detail-body" class="divide-y divide-gray-50"></tbody>
                            <tfoot class="bg-gray-50 font-bold text-gray-900 border-t border-gray-200">
                                <tr>
                                    <td class="pt-4 pb-4 pl-4" colspan="4">Estimated Monthly Total</td>
                                    <td class="pt-4 pb-4 text-right pr-4 text-green-600 text-xl"
                                        id="cost-total-display">$ 0.00</td>
                                </tr>
                            </tfoot>
                        </table>
                        <p class="text-[10px] text-gray-400 mt-6 flex items-center gap-1"><i data-lucide="info"
                                class="w-3 h-3"></i> Estimates based on On-Demand pricing. Excludes Data Transfer fees.
                        </p>
                    </div>
                </div>

            </div>
        </div>

        <div id="terminal-overlay"
            class="hidden absolute inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-center justify-center">
            <div
                class="w-[900px] h-[600px] bg-[#1e1e1e] border border-gray-700 rounded-xl shadow-2xl flex flex-col font-mono text-xs overflow-hidden">
                <div class="h-10 bg-[#252526] border-b border-gray-700 flex items-center px-4 justify-between">
                    <div class="flex gap-2">
                        <div class="w-3 h-3 rounded-full bg-[#ff5f56] hover:brightness-110 cursor-pointer"
                            onclick="closeTerminal()"></div>
                        <div class="w-3 h-3 rounded-full bg-[#ffbd2e]"></div>
                        <div class="w-3 h-3 rounded-full bg-[#27c93f]"></div>
                    </div>
                    <div class="text-gray-400 font-bold">aws-omakase-deploy-agent â€” ssh</div>
                    <div class="w-4"></div>
                </div>
                <div class="flex-1 p-6 overflow-y-auto custom-scrollbar text-gray-300 space-y-1" id="console-output"
                    style="background-color: #1e1e1e;"></div>
                <div class="p-4 border-t border-gray-700 bg-[#252526] hidden flex justify-between items-center"
                    id="deploy-footer">
                    <div class="flex items-center gap-2 text-green-400 font-bold"><i data-lucide="check-circle"
                            class="w-4 h-4"></i> Deployment Successful</div>
                    <button onclick="location.href='/monitoring'"
                        class="bg-[#238636] hover:bg-[#2ea043] text-white px-6 py-2 rounded font-bold transition">View
                        Dashboard</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        lucide.createIcons();

        let state = { instanceType: 't3.micro', instanceCost: 25, nodeCount: 2, dbEngine: 'mysql', dbMultiAZ: true, dbSize: 50, redis: false, waf: false, cdn: false };

        function switchTab(tabId) {
            document.querySelectorAll('.scroll-view-absolute').forEach(el => el.classList.add('hidden'));
            document.getElementById(`tab-${tabId}`).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        function setInstanceTier(type, cost, el) {
            state.instanceType = type; state.instanceCost = cost;
            const siblings = el.parentElement.children;
            for (let sib of siblings) sib.classList.remove('active');
            el.classList.add('active');
            refreshEngine();
        }

        function updateSlider(id, val, suffix) { document.getElementById(id).innerText = val + suffix; }
        function copyToClipboard(id) { navigator.clipboard.writeText(document.getElementById(id).innerText).then(() => alert('Copied!')); }
        function closeTerminal() { document.getElementById('terminal-overlay').classList.add('hidden'); }

        function validateAndRefresh() {
            const name = document.getElementById('svc_name').value;
            const err = document.getElementById('err_name');
            if (name && !/^[a-z0-9-]+$/.test(name)) {
                err.style.display = 'block';
                document.getElementById('svc_name').classList.add('input-error');
            } else {
                err.style.display = 'none';
                document.getElementById('svc_name').classList.remove('input-error');
                refreshEngine();
            }
        }

        function refreshEngine() {
            try {
                state.nodeCount = parseInt(document.getElementById('node_count').value) || 2;
                state.dbEngine = document.getElementById('db_engine').value;
                state.dbMultiAZ = document.getElementById('chk_multiaz').checked;
                state.redis = document.getElementById('chk_redis').checked;
                state.dbSize = parseInt(document.getElementById('db_size').value) || 50;
                state.waf = document.getElementById('chk_waf').checked;
                state.cdn = document.getElementById('chk_cdn').checked;

                const region = document.getElementById('region_select').value;
                const svcName = document.getElementById('svc_name').value || 'demo-service';
                const env = document.getElementById('env_tag').value;

                // Costs
                const computeTotal = state.instanceCost * state.nodeCount;
                const dbBase = state.dbEngine === 'aurora' ? 100 : (state.instanceType === 't3.micro' ? 15 : 50);
                const dbStorageCost = (state.dbSize * 0.12);
                const dbTotal = (dbBase + dbStorageCost) * (state.dbMultiAZ ? 2 : 1);
                const extraCost = (state.redis ? 40 : 0) + (state.waf ? 30 : 0) + (state.cdn ? 20 : 0);
                const totalMonthly = computeTotal + dbTotal + extraCost;

                document.getElementById('header-cost').innerText = `$ ${totalMonthly.toFixed(2)}`;
                document.getElementById('cost-total-display').innerText = `$ ${totalMonthly.toFixed(2)}`;

                const costBody = document.getElementById('cost-detail-body');
                costBody.innerHTML = `
                    <tr><td class="pl-2 py-3 font-medium text-gray-900">EC2 Instances</td><td class="py-3">${state.instanceType} x ${state.nodeCount}</td><td class="text-right py-3">$${state.instanceCost}</td><td class="text-right py-3">${state.nodeCount}</td><td class="text-right pr-2 py-3 font-bold text-gray-900">$${computeTotal.toFixed(2)}</td></tr>
                    <tr><td class="pl-2 py-3 font-medium text-gray-900">Database</td><td class="py-3">${state.dbEngine}</td><td class="text-right py-3">$${dbBase}</td><td class="text-right py-3">${state.dbMultiAZ ? 2 : 1}</td><td class="text-right pr-2 py-3 font-bold text-gray-900">$${dbTotal.toFixed(2)}</td></tr>
                    ${state.redis ? `<tr><td class="pl-2 py-3 font-medium text-gray-900">ElastiCache</td><td class="py-3">Redis Cluster</td><td class="text-right py-3">$40</td><td class="text-right py-3">1</td><td class="text-right pr-2 py-3 font-bold text-gray-900">$40.00</td></tr>` : ''}
                    ${state.waf ? `<tr><td class="pl-2 py-3 font-medium text-gray-900">Security</td><td class="py-3">WAF ACL</td><td class="text-right py-3">$30</td><td class="text-right py-3">1</td><td class="text-right pr-2 py-3 font-bold text-gray-900">$30.00</td></tr>` : ''}
                `;

                renderTopology(svcName, region);

                const tfContent = generateTerraform(svcName, env, region);
                const tfEl = document.getElementById('code-tf');
                tfEl.textContent = tfContent;
                tfEl.removeAttribute('data-highlighted');
                hljs.highlightElement(tfEl);

                const cfnContent = generateCloudFormation(svcName, env);
                const cfnEl = document.getElementById('code-cfn');
                cfnEl.textContent = JSON.stringify(cfnContent, null, 2);
                cfnEl.removeAttribute('data-highlighted');
                hljs.highlightElement(cfnEl);

                const haEl = document.getElementById('stat-ha');
                haEl.innerText = state.dbMultiAZ ? "Enabled (Multi-AZ)" : "Disabled (Single-AZ)";
                haEl.className = state.dbMultiAZ ? "text-sm font-bold text-green-600" : "text-sm font-bold text-yellow-600";

            } catch (e) { console.error(e); }
        }

        function renderTopology(svcName, region) {
            document.getElementById('region-label').innerText = `AWS Region: ${region}`;
            const lbHtml = `<div class="topo-subnet w-full justify-center bg-white border-dashed border-gray-300 mb-2"><div class="topo-icon bg-purple-50 text-purple-600 border border-purple-200"><i data-lucide="shield" class="w-4 h-4"></i></div><span class="text-gray-600 font-bold">Public ALB (${svcName}-lb)</span></div>`;
            document.getElementById('topo-lb-layer').innerHTML = lbHtml;

            const azCount = state.dbMultiAZ ? 2 : 1;
            let azHtml = '';
            for (let i = 0; i < azCount; i++) {
                const zone = i === 0 ? 'a' : 'c';
                const nodeCount = Math.ceil(state.nodeCount / azCount);
                let nodesHtml = '';
                for (let j = 0; j < nodeCount; j++) {
                    nodesHtml += `<div class="topo-subnet"><div class="topo-icon bg-orange-50 text-[#ec7211] border border-orange-200"><i data-lucide="cpu" class="w-4 h-4"></i></div><span class="text-gray-700">EC2 Node 0${j + 1}</span></div>`;
                }
                azHtml += `<div class="topo-az"><div class="topo-az-label">${region}${zone}</div><div class="mb-2 text-[10px] text-gray-400 font-bold uppercase tracking-wider">Public Tier</div><div class="topo-subnet border-green-500/30 bg-green-50/50"><div class="topo-icon bg-green-50 text-green-600 border border-green-200"><i data-lucide="network" class="w-4 h-4"></i></div><span class="text-gray-700">NAT Gateway</span></div><div class="mt-3 mb-2 text-[10px] text-gray-400 font-bold uppercase tracking-wider">App Tier</div>${nodesHtml}<div class="mt-3 mb-2 text-[10px] text-gray-400 font-bold uppercase tracking-wider">Data Tier</div><div class="topo-subnet border-blue-500/30 bg-blue-50/50"><div class="topo-icon bg-blue-50 text-blue-600 border border-blue-200"><i data-lucide="database" class="w-4 h-4"></i></div><span class="text-gray-700">${state.dbEngine} ${i === 0 ? 'Primary' : 'Replica'}</span></div>${state.redis ? `<div class="topo-subnet border-red-500/30 bg-red-50/50"><div class="topo-icon bg-red-50 text-red-600 border border-red-200"><i data-lucide="zap" class="w-4 h-4"></i></div><span class="text-gray-700">Redis Cache</span></div>` : ''}</div>`;
            }
            document.getElementById('topo-az-container').innerHTML = azHtml;
            lucide.createIcons();
        }

        // --- MASSIVELY EXPANDED TERRAFORM CODE (FOR SCROLLING) ---
        function generateTerraform(name, env, region) {
            return `# Terraform Configuration for ${name}
# Environment: ${env}
# Region: ${region}
# Generated by AWS Omakase Architect Pro v6.6

terraform {
  required_version = ">= 1.5.0"
  required_providers {
    aws = { source = "hashicorp/aws", version = "~> 5.0" }
    random = { source = "hashicorp/random", version = "~> 3.0" }
  }
  backend "s3" {
    bucket         = "omakase-tf-state-${name}"
    key            = "${env}/terraform.tfstate"
    region         = "${region}"
    encrypt        = true
    dynamodb_table = "omakase-lock-table"
  }
}

provider "aws" {
  region = "${region}"
  default_tags {
    tags = {
      Project     = "${name}"
      ManagedBy   = "Omakase"
      Environment = "${env}"
      CostCenter  = "Engineering-001"
    }
  }
}

# -----------------------------------------------------------------
# 1. VARS & LOCALS
# -----------------------------------------------------------------
variable "vpc_cidr" { default = "10.0.0.0/16" }
variable "instance_type" { default = "${state.instanceType}" }

locals {
  common_name = "${name}-${env}"
}

# -----------------------------------------------------------------
# 2. NETWORK LAYER (VPC, Subnets, Gateways)
# -----------------------------------------------------------------
module "vpc" {
  source = "terraform-aws-modules/vpc/aws"
  version = "5.0.0"

  name = local.common_name
  cidr = var.vpc_cidr

  azs             = ["${region}a", "${region}c"]
  private_subnets = ["10.0.1.0/24", "10.0.2.0/24"]
  public_subnets  = ["10.0.101.0/24", "10.0.102.0/24"]
  database_subnets = ["10.0.201.0/24", "10.0.202.0/24"]

  enable_nat_gateway     = true
  single_nat_gateway     = ${!state.dbMultiAZ}
  one_nat_gateway_per_az = ${state.dbMultiAZ}
  
  enable_dns_hostnames = true
  enable_dns_support   = true
  
  # VPC Flow Logs
  enable_flow_log                      = true
  create_flow_log_cloudwatch_log_group = true
  create_flow_log_cloudwatch_iam_role  = true
  flow_log_max_aggregation_interval    = 60
}

# -----------------------------------------------------------------
# 3. SECURITY & IAM
# -----------------------------------------------------------------
resource "aws_security_group" "alb" {
  name        = "${name}-alb-sg"
  description = "ALB Security Group"
  vpc_id      = module.vpc.vpc_id

  ingress {
    description = "HTTP from Internet"
    from_port   = 80
    to_port     = 80
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
  }

  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
  }
}

resource "aws_iam_role" "ec2" {
  name = "${name}-ec2-role"
  assume_role_policy = jsonencode({
    Version = "2012-10-17"
    Statement = [{
      Action = "sts:AssumeRole"
      Effect = "Allow"
      Principal = { Service = "ec2.amazonaws.com" }
    }]
  })
}

resource "aws_iam_role_policy_attachment" "ssm" {
  role       = aws_iam_role.ec2.name
  policy_arn = "arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore"
}

# -----------------------------------------------------------------
# 4. COMPUTE LAYER (ASG & Launch Template)
# -----------------------------------------------------------------
resource "aws_launch_template" "app" {
  name_prefix   = "${name}-tpl"
  image_id      = "ami-0c9c942bd7bf113a2" 
  instance_type = var.instance_type
  
  iam_instance_profile {
    name = aws_iam_instance_profile.app.name
  }

  monitoring { enabled = true }
  
  block_device_mappings {
    device_name = "/dev/xvda"
    ebs {
      volume_size = 30
      volume_type = "gp3"
      encrypted   = true
    }
  }

  user_data = base64encode(<<-EOF
    #!/bin/bash
    echo "Initializing..."
    yum update -y
    yum install -y nginx
    systemctl start nginx
  EOF
  )
}

resource "aws_autoscaling_group" "app" {
  name                = "${name}-asg"
  desired_capacity    = ${state.nodeCount}
  max_size            = ${state.nodeCount * 2}
  min_size            = 1
  vpc_zone_identifier = module.vpc.private_subnets
  target_group_arns   = [] 
  health_check_type   = "ELB"
  
  launch_template {
    id      = aws_launch_template.app.id
    version = "$Latest"
  }

  tag {
    key                 = "Name"
    value               = "${name}-worker"
    propagate_at_launch = true
  }
}

# -----------------------------------------------------------------
# 5. DATABASE LAYER (RDS)
# -----------------------------------------------------------------
resource "aws_db_instance" "default" {
  identifier           = "${name}-db"
  allocated_storage    = ${state.dbSize}
  engine               = "${state.dbEngine}"
  engine_version       = "8.0"
  instance_class       = "${state.instanceType === 't3.micro' ? 'db.t3.micro' : 'db.m5.large'}"
  multi_az             = ${state.dbMultiAZ}
  storage_encrypted    = true
  username             = "admin"
  password             = "Omakase123!" 
  skip_final_snapshot  = true
  db_subnet_group_name = module.vpc.database_subnet_group_name
  vpc_security_group_ids = [module.vpc.default_security_group_id]
  
  backup_retention_period = 7
}

${state.redis ? `# -----------------------------------------------------------------
# 6. CACHING LAYER (Redis)
# -----------------------------------------------------------------
resource "aws_elasticache_cluster" "redis" {
  cluster_id           = "${name}-redis"
  engine               = "redis"
  node_type            = "cache.t3.micro"
  num_cache_nodes      = 1
  parameter_group_name = "default.redis7"
  port                 = 6379
  subnet_group_name    = module.vpc.database_subnet_group_name
}` : ''}

${state.waf ? `# -----------------------------------------------------------------
# 7. SECURITY LAYER (WAF)
# -----------------------------------------------------------------
resource "aws_wafv2_web_acl" "main" {
  name        = "${name}-waf"
  scope       = "REGIONAL"
  default_action { allow {} }
  visibility_config {
    cloudwatch_metrics_enabled = true
    metric_name                = "${name}-waf"
    sampled_requests_enabled   = true
  }
}` : ''}

# -----------------------------------------------------------------
# 8. OUTPUTS
# -----------------------------------------------------------------
output "vpc_id" {
  description = "The ID of the VPC"
  value       = module.vpc.vpc_id
}

output "db_endpoint" {
  description = "The connection endpoint"
  value       = aws_db_instance.default.endpoint
}

output "asg_name" {
  value = aws_autoscaling_group.app.name
}`;
        }

        function generateCloudFormation(name, env) {
            return {
                "AWSTemplateFormatVersion": "2010-09-09",
                "Description": `Stack for ${name} (${env}) - Generated by Omakase`,
                "Parameters": {
                    "EnvType": { "Type": "String", "Default": env },
                    "InstanceCount": { "Type": "Number", "Default": state.nodeCount }
                },
                "Resources": {
                    "VPC": {
                        "Type": "AWS::EC2::VPC",
                        "Properties": {
                            "CidrBlock": "10.0.0.0/16",
                            "EnableDnsSupport": true,
                            "EnableDnsHostnames": true,
                            "Tags": [{ "Key": "Name", "Value": `${name}-vpc` }]
                        }
                    },
                    "InternetGateway": {
                        "Type": "AWS::EC2::InternetGateway"
                    },
                    "VPCGatewayAttachment": {
                        "Type": "AWS::EC2::VPCGatewayAttachment",
                        "Properties": {
                            "VpcId": { "Ref": "VPC" },
                            "InternetGatewayId": { "Ref": "InternetGateway" }
                        }
                    },
                    "ASG": {
                        "Type": "AWS::AutoScaling::AutoScalingGroup",
                        "Properties": {
                            "MinSize": "1",
                            "MaxSize": String(state.nodeCount * 2),
                            "DesiredCapacity": String(state.nodeCount),
                            "HealthCheckType": "ELB",
                            "HealthCheckGracePeriod": 300
                        }
                    },
                    "DB": {
                        "Type": "AWS::RDS::DBInstance",
                        "Properties": {
                            "Engine": state.dbEngine,
                            "AllocatedStorage": String(state.dbSize),
                            "MultiAZ": state.dbMultiAZ,
                            "DBInstanceClass": state.instanceType === 't3.micro' ? 'db.t3.micro' : 'db.m5.large',
                            "StorageType": "gp3",
                            "StorageEncrypted": true
                        }
                    }
                },
                "Outputs": {
                    "VPCId": { "Value": { "Ref": "VPC" } },
                    "DBEndpoint": { "Value": { "Fn::GetAtt": ["DB", "Endpoint.Address"] } }
                }
            };
        }

        function deploy() {
            const svcName = document.getElementById('svc_name').value || 'demo-service';
            document.getElementById('terminal-overlay').classList.remove('hidden');
            const consoleDiv = document.getElementById('console-output');
            consoleDiv.innerHTML = '';

            const steps = [
                `[CLI] Initializing AWS Omakase Engine v6.6...`,
                `[AUTH] Authenticating... OK`,
                `[PLAN] Validating configuration...`,
                `-------------------------------------------------------`,
                `[VPC] Creating VPC 'vpc-${svcName}'...`,
                `[Subnet] Creating Public/Private Subnets...`,
                `[IGW] Attaching Internet Gateway... DONE`,
                `[NAT] Provisioning NAT Gateway... DONE`,
                `[SG] Creating Security Groups... DONE`,
                `[DB] Launching ${state.dbEngine} Instance...`,
                `[ASG] Launching ${state.nodeCount} x EC2 Nodes...`,
                `[ALB] Provisioning Load Balancer...`,
            ];

            if (state.redis) steps.push(`[Redis] Launching ElastiCache... DONE`);
            if (state.cdn) steps.push(`[CDN] Deploying CloudFront... (InProgress)`);
            if (state.waf) steps.push(`[WAF] Attaching Web ACL... DONE`);

            steps.push(`-------------------------------------------------------`);
            steps.push(`[OUTPUT] Service URL: https://${svcName}.api.omakase.link`);
            steps.push(`[SUCCESS] Stack Provisioning Complete.`);

            let i = 0;
            function printLog() {
                if (i >= steps.length) {
                    document.getElementById('deploy-footer').classList.remove('hidden');
                    document.getElementById('deploy-footer').classList.add('flex');
                    return;
                }
                const div = document.createElement('div');
                div.className = steps[i].includes('[SUCCESS]') ? "text-green-400 font-bold mt-4" : "text-gray-300 mb-1";
                div.innerText = `> ${steps[i]}`;
                consoleDiv.appendChild(div);
                consoleDiv.scrollTop = consoleDiv.scrollHeight;
                i++;
                setTimeout(printLog, 300 + Math.random() * 500);
            }
            printLog();

            try {
                fetch('/api/provision', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ serviceName: svcName, config: state, targetInfra: {} })
                });
            } catch (e) { }
        }

        refreshEngine();
    </script>
</body>

</html>